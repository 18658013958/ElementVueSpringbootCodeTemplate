<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>晓风轻Vue+SpringBoot代码模板 | 使用redis</title>
    <meta name="description" content="晓风轻Vue+SpringBoot代码模板">
    
    
    <link rel="preload" href="/ElementVueSpringbootCodeTemplate/assets/css/14.styles.e491d3bf.css" as="style"><link rel="preload" href="/ElementVueSpringbootCodeTemplate/assets/js/app.63780be1.js" as="script"><link rel="preload" href="/ElementVueSpringbootCodeTemplate/assets/js/2.29db06ad.js" as="script"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/4.0826e6e3.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/0.0469b2e3.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/1.b24e82eb.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/3.47a72772.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/5.b0259ce2.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/6.6ea7ec8b.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/7.fbff5130.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/8.5c948da2.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/9.18ddf435.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/10.feb7dd37.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/11.50f114eb.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/12.f165da3b.js"><link rel="prefetch" href="/ElementVueSpringbootCodeTemplate/assets/js/13.0b419ce3.js">
    <link rel="stylesheet" href="/ElementVueSpringbootCodeTemplate/assets/css/14.styles.e491d3bf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/ElementVueSpringbootCodeTemplate/" class="home-link router-link-active"><!----><span class="site-name">
      晓风轻Vue+SpringBoot代码模板
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/ElementVueSpringbootCodeTemplate/" class="nav-link">首页</a></div><div class="nav-item"><a href="/ElementVueSpringbootCodeTemplate/note/" class="nav-link router-link-active">开发笔记</a></div><a href="https://github.com/xwjie/ElementVueSpringbootCodeTemplate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ElementVueSpringbootCodeTemplate/" class="nav-link">首页</a></div><div class="nav-item"><a href="/ElementVueSpringbootCodeTemplate/note/" class="nav-link router-link-active">开发笔记</a></div><a href="https://github.com/xwjie/ElementVueSpringbootCodeTemplate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>开发笔记</span><!----></p><ul class="sidebar-group-items"><li><a href="/ElementVueSpringbootCodeTemplate/note/" class="sidebar-link">开发笔记说明</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html" class="active sidebar-link">使用redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#为什么使用redis" class="sidebar-link">为什么使用redis</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#增加redis依赖" class="sidebar-link">增加redis依赖</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#增加redis配置" class="sidebar-link">增加redis配置</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#配置redis" class="sidebar-link">配置redis</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#使用缓存" class="sidebar-link">使用缓存</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#定时清空缓存" class="sidebar-link">定时清空缓存</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#redis-怎么样保存cache" class="sidebar-link">redis 怎么样保存cache</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#安装redis" class="sidebar-link">安装redis</a></li><li class="sidebar-sub-header"><a href="/ElementVueSpringbootCodeTemplate/note/use-redis-cache.html#redis-比较重要命令" class="sidebar-link">redis 比较重要命令</a></li></ul></li><li><a href="/ElementVueSpringbootCodeTemplate/note/update-elementui.html" class="sidebar-link">ElementUI升级2.0.2</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/spring-jpa-data-use-h2-database.html" class="sidebar-link">使用H2数据库</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/vue-filter.html" class="sidebar-link">增加vue过滤器</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/enable-swagger2.html" class="sidebar-link">增加swagger2</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/vue-comps.html" class="sidebar-link">Vue组件</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/spring-security.html" class="sidebar-link">Spring Security 使用</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/hibernate.html" class="sidebar-link">hibernate 笔记</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/jms.html" class="sidebar-link">JMS使用</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/springboot.html" class="sidebar-link">springboot笔记</a></li><li><a href="/ElementVueSpringbootCodeTemplate/note/keng.html" class="sidebar-link">踩坑记</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="使用redis"><a href="#使用redis" aria-hidden="true" class="header-anchor">#</a> 使用redis</h1><h2 id="为什么使用redis"><a href="#为什么使用redis" aria-hidden="true" class="header-anchor">#</a> 为什么使用redis</h2><p>性能有保证，redis支持集群等，数据也有保证。而且后面使用 <code>spring-session</code> 做分布式Session的时候，也是使用redis做持久化。所以一次到位直接使用redis。</p><h2 id="增加redis依赖"><a href="#增加redis依赖" aria-hidden="true" class="header-anchor">#</a> 增加redis依赖</h2><pre class="language-text"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h2 id="增加redis配置"><a href="#增加redis配置" aria-hidden="true" class="header-anchor">#</a> 增加redis配置</h2><p><code>application.yml</code> 上增加：</p><pre class="language-text"><code>spring:
  redis:
    host: localhost
    port: 6379
</code></pre><h2 id="配置redis"><a href="#配置redis" aria-hidden="true" class="header-anchor">#</a> 配置redis</h2><p>继承CachingConfigurerSupport，增加 <code>@EnableCaching</code> 注解，需要重写 <code>keyGenerator</code> 方法。</p><pre class="language-text"><code>@Configuration
@EnableCaching
public class RedisConfig extends CachingConfigurerSupport
</code></pre><p>在类里面配置 <code>RestTemplate</code> ，需要配置key和value的序列化类。</p><p>key序列化使用<code>StringRedisSerializer</code>, 不配置的话key前面会出现乱码。</p><p>value序列化使用 <code>GenericJackson2JsonRedisSerializer</code> ，保存为Json格式。该类目前反序列化还有一些bug，只能反序列化实现了Serialize的类。</p><pre class="language-text"><code>@Bean
public RedisTemplate&lt;String, String&gt; redisTemplate(RedisConnectionFactory factory) {
  RedisTemplate template = new RedisTemplate();

  template.setConnectionFactory(factory);

  RedisSerializer keySerializer = new StringRedisSerializer();

  // 设置key序列化类，否则key前面会多了一些乱码
  template.setKeySerializer(keySerializer);
  template.setHashKeySerializer(keySerializer);

  // FIXME 有些版本有bug，没有序列化的只能序列化，但无法反序列化
  GenericJackson2JsonRedisSerializer jsonSerializer = new GenericJackson2JsonRedisSerializer();

  // 设置内容序列化类
  template.setValueSerializer(jsonSerializer);

  template.afterPropertiesSet();

  return template;
}
</code></pre><p>配置 CacheManager，包括指定缓存和默认缓存的超时时间的配置。</p><pre class="language-text"><code>@Bean
public CacheManager cacheManager(RedisTemplate redisTemplate) {
  RedisCacheManager cacheManager = new RedisCacheManager(redisTemplate);

  Map&lt;String, Long&gt; expires = new HashMap&lt;&gt;();

  expires.put(CacheNames.CONFIG, 60L);

  // 设置超时
  cacheManager.setExpires(expires);

  // 没有设置的缓存默认过期时间
  cacheManager.setDefaultExpiration(60 * 60);

  return cacheManager;
}
</code></pre><p>重写 <code>keyGenerator</code>，可以支持使用@Cacheable不指定Key。</p><pre class="language-text"><code>@Override
public KeyGenerator keyGenerator() {
  return new KeyGenerator() {
    @Override
    public Object generate(Object target, Method method, Object... params) {
      StringBuilder sb = new StringBuilder();
      
      sb.append(target.getClass().getSimpleName());
      sb.append('.').append(method.getName());

      // FIXME 参数太长的时候请指定key属性，否则key太长
      for (Object obj : params) {
        if (obj != null) {
          sb.append(obj.toString());
        }
      }

      return sb.toString();
    }
  };
}
</code></pre><h2 id="使用缓存"><a href="#使用缓存" aria-hidden="true" class="header-anchor">#</a> 使用缓存</h2><p>保存的时候使用 <code>@Cacheable</code>，清空使用 <code>@CacheEvict</code> ，更新的时候使用 <code>@CachePut</code> 。</p><p>反序列化有bug，没有实现 <code>Serializable</code> 的只能序列化，无法反序列化。可能后续版本会解决该问题。</p><p>所以把下面的查询代码修改一下，用 实现了 <code>Serializable</code> 的 <code>ArrayList</code> 包装返回。</p><pre class="language-text"><code>@Cacheable(&quot;config&quot;)
@Override
public Collection&lt;Config&gt; getAll() {
  System.out.println(&quot;\n----------GetAll----------\n&quot;);
  return new ArrayList&lt;&gt;(configs.values());
}

@CacheEvict(value = CacheNames.CONFIG, allEntries = true)
@Override
public long add(Config config) {

}

/**
 * 删除配置项
 */
@CacheEvict(value = CacheNames.CONFIG, allEntries = true)
@Override
public boolean delete(long id) {
  
}
</code></pre><h2 id="定时清空缓存"><a href="#定时清空缓存" aria-hidden="true" class="header-anchor">#</a> 定时清空缓存</h2><p>也可以定时清空cache，使用 <code>@EnableScheduling</code> 和 <code>@Scheduled</code> 注解。</p><pre class="language-text"><code>@Component
@EnableScheduling
public class ClearCacheTask {

  /**
   * 定时清空缓存
   */
  @Scheduled(fixedRate = 60 * 1000L)
  @CacheEvict(value = { CacheNames.CONFIG }, allEntries = true)
  public void clearCaches() {
    System.out.println(&quot;\n------------ clear caches ------------\n&quot;);
  }
}
</code></pre><h2 id="redis-怎么样保存cache"><a href="#redis-怎么样保存cache" aria-hidden="true" class="header-anchor">#</a> redis 怎么样保存cache</h2><p>增加2条数据，一个是类型为 <code>zset</code> 的 <code>缓存名~keys</code> , 里面存放了该缓存所有的key， 一个是对应的key，值为序列化后的json。</p><p><code>zset</code> 是带权重的有序集合，可以使用 <code>zrange config~keys -1 1 withscores</code> 查看元素，新加入的都是 0.0 。使用 <code>zcount config~keys -1 1</code> 查看个数。</p><p>可以使用 <code>ttl</code> 命令查看超时时间，单位为秒。</p><p><img src="/pictures/redisconsole.png" alt="redis console"></p><h2 id="安装redis"><a href="#安装redis" aria-hidden="true" class="header-anchor">#</a> 安装redis</h2><p>https://github.com/MicrosoftArchive/redis/releases 下载最新版本，3.2</p><p>启动</p><pre class="language-text"><code>redis-server.exe redis.windows.conf
</code></pre><p>也可以使用 <a href="https://github.com/caoxinyu/RedisClient" target="_blank" rel="noopener noreferrer">Redis Client</a> 查看。</p><p><img src="/pictures/redisclient.png" alt="redis client"></p><h2 id="redis-比较重要命令"><a href="#redis-比较重要命令" aria-hidden="true" class="header-anchor">#</a> redis 比较重要命令</h2><ul><li>keys * / keys cn* 查看数据</li><li>type keyname 查看数据类型</li><li>dbsize 查看记录数</li><li>flushdb 删除【当前数据库】所有记录</li><li>flushall 删除所有数据库里面的所有数据，注意不是当前数据库，而是所有数据库。</li><li>expire，ttl 设置和查看超时时间</li><li>select 选择0-15号数据库</li></ul></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/ElementVueSpringbootCodeTemplate/note/" class="prev router-link-active">
          开发笔记说明
        </a></span><span class="next"><a href="/ElementVueSpringbootCodeTemplate/note/update-elementui.html">
          ElementUI升级2.0.2
        </a> →
      </span></p></div></div></div></div>
    <script src="/ElementVueSpringbootCodeTemplate/assets/js/2.29db06ad.js" defer></script><script src="/ElementVueSpringbootCodeTemplate/assets/js/app.63780be1.js" defer></script>
  </body>
</html>
